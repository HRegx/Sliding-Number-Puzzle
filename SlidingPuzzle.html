<!DOCTYPE html>
<html lang="en">
<head>
    <title>Slide</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
    <canvas id="myCanvas" width="440" height="440" style="border: 1px solid #000000;">
    </canvas>
 
    <script>
        var interval =3;
        var intervalId;

        window.onload=function(){
            thisCanvas = document.getElementById("myCanvas");
            thisContext = thisCanvas.getContext("2d");             
            startInterval(interval);            
        }

            
        function startInterval(_interval) {           
            intervalId = setInterval(NumberPuzzle,1000/_interval);
        }

        var _numbers= [
                [0,0,1], [1,0,2],  [2,0,3], [3,0,4],
                [0,1,5], [1,1,6],  [2,1,7], [3,1,8],
                [0,2,9], [1,2,10], [2,2,11],[3,2,12],
                [0,3,13],[1,3,14], [2,3,15],[3,3,0]
                ];                

        var _isPause=false
        var _state ="NONE"
        var _status="LOOKUP";
        var _engine="IGNITE"
        var onlyOnce=true;
        var _oO = true        

        var _tail = 1;
        var targetNum=1;
        var _five = 5         

        var topY=0;        
        var _hold=0;    
        var counter = 0;                
        

        var pathWay=[];
        var _xpos =[0,1,6,7]                
        var _o = [0,1]        
        


        function _getLocation(num,a,b){
            let _sl = _numbers.filter(x=>x[2]==num)
                xy[a]=_sl[0][0];
                xy[b]=_sl[0][1];
        }

        var xy=[0,1,2,3]
        function _shuffle(){
        var _decision =  (max) => {
            return Math.floor(Math.random() * max)
            }                    

            for(let i=0;i<=55;i++){
                var _tN = _decision(16)
                _getLocation(0,0,1)
                _getLocation(_tN,2,3)
                createPathWay(...xy,0,0)

                let c=0
                while(c<pathWay.length-2){                
                    _swap(pathWay[c],pathWay[c+1])   
                    c+=1           
                }
            } 

        }
            
        function NumberPuzzle(){ //###############################################
            if(_isPause==true){return;}
            let x = 55;
            let y = 55;
            let grid = 3;
            let ten = 22;

            if(targetNum==14){
                clearInterval(intervalId);
                startInterval(5000);
            }
                
            thisContext.fillStyle="silver";
            thisContext.fillRect(0,0,thisCanvas.width,thisCanvas.height);

            // if(onlyOnce){
            //     _shuffle();
            //     onlyOnce=false;
            onlyOnce && _shuffle();
            onlyOnce=false;
            // }
                        
            for(let i=0;i<=15;i++){ 

                _getLocation(0,0,1)
                _getLocation(targetNum,2,3)

                              
                if(_numbers[i][2]>=10){  // text centering 10 plus
                    ten=38;
                }

                thisContext.beginPath();
                if(_numbers[i][2]!=0){  
                    thisContext.fillStyle = 'darkslateblue';                          
                }else{
                    thisContext.fillStyle="silver";
                }
                    thisContext.arc(x, y, 50, 0, 2 * Math.PI);                    
                    thisContext.fill();
                    
                if(_numbers[i][2]!=0){  
                    thisContext.fillStyle = 'white';
                }
                    thisContext.font = "69px Trebuchet MS";
                    thisContext.fillText(_numbers[i][2],x-ten,y+24)  
                                        
                ten=22
                if(i==grid){
                    x=-55;
                    y+=110;
                    grid+=4;                        
                }
                x+=110
            }

        if(_engine=="IGNITE"){
            _workOut(...xy)                                       
        }

                                          
        }  

        // var numbersXYTemp=[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15];
                                
        // function shuffleNumbers(){
        //     let myMax = numbersXYTemp.length;        
        //     let myRadom;
        //     let j=0;

           
        //     for(let i = 0;i <= myMax;i ++){
        //         myRandom = Math.floor(Math.random()*myMax)
        //         numbersXYTemp.push(numbersXYTemp[myRandom]);
        //         numbersXYTemp.splice(myRandom,1); // 2nd parameter means remove one item only                     
        //         myMax-=1;
        //         i=0;                
        //     }
        //     for(let i=0;i<=15;i++){
        //         _numbers[i][2]=numbersXYTemp[i];
        //     }                    
        // }    
        
        var ar=[0,1,2,3,1,2,3,4];
        function isAlign(_a,_b,_c,_d,_w,_x,_y,_z){  
            if((_numbers[_a][2]==_w) && (_numbers[_b][2]==_x) && (_numbers[_c][2]==_y) && (_numbers[_d][2]==_z)){
                return true;
            }else{
                return false;
            }
        }

        function obstacle(){           
            for(let nums of pathWay){
                if(_numbers[nums][2]!=0){
                    if(targetNum>_numbers[nums][2]){
                        return true;
                    }
                }
            }
        }

        function createPathWay(_sX,_sY,_tX,_tY,_dX,_dY){
            let _LR = [_sX,_tX,_dX];
            let _TB = [_sY,_tY,_dY];
            _LR.sort(function(a,b){return a-b});
            _TB.sort(function(a,b){return a-b});


            if((_LR[0]==_LR[2])&&(_LR[0]<=2)){_LR[2]+=1}else{if((_LR[0]==3)&&(_LR[2]==3)){_LR[0]-=1}}
            if((_TB[0]==_TB[2])&&(_TB[0]<=2)){_TB[2]+=1}else{if((_TB[0]==3)&&(_TB[2]==3)){_TB[0]-=1}}
            
            pathWay=[];
               
         
            let _p=0;            
            let _m=3;            
            let _tarr=[];
            let _rarr=[];
            let _barr=[];
            let _larr=[];

            while (_p<=3){
                if((_LR[0]<=_p)&&(_p<=_LR[2])){_tarr.push([_p,_TB[0]])}
                if((_TB[0]+1<=_p)&&(_p<=_TB[2])){_rarr.push([_LR[2],_p])}
                if((_LR[2]-1>=_m)&&(_m>=_LR[0])){_barr.push([_m,_TB[2]])}
                if((_TB[2]-1>=_m)&&(_m>=_TB[0]+1)){_larr.push([_LR[0],_m])}                
                _m--;
                _p++;
            }

            _tarr=_tarr.concat(_rarr,_barr,_larr)
      
            for(let i=0;i<=_tarr.length-1;i++){  //populate the pathWay
                for(let j=0;j<=_numbers.length-1;j++){
                    if(_tarr[i][0]==_numbers[j][0] && _tarr[i][1]==_numbers[j][1]){
                    pathWay.push(j);                  
                    }
                }
            }  
           
            //rearrange the  dynamic _tarr spaceLocation must go first           
            let w=pathWay.length;   
            for(let i=0;i<=w;i++){
                pathWay.push(pathWay[0])
                pathWay.shift()                    
                if(_numbers[pathWay[0]][2]==0){  
                    pathWay.push(pathWay[0]);  //add the first elements of pathWay to the last for rotations                                                                                                 
                    return;
                }           
            }                        
                       
        }
        
        function _lookUp(_arg){
            let _option=[_arg+5,_arg+6,_arg+2];            
            if(_arg>=_xpos[2]){
                _option=[_arg-5,_arg-6,_arg-2];
            }

            for(i=0;i<=2;i++){
                if(_numbers[_option[i]][2]==targetNum){
                    return true;
                }
            }
            return false;
        }

        function _reset(){
            createPathWay(0,_o[0],3,_o[1],0,_o[0])
            counter=0
            _status="SLIDE"            
        }
          
        function _swap(_a,_b){
            [_numbers[_a][2],_numbers[_b][2]]=[_numbers[_b][2],_numbers[_a][2]];                                                                  
        }

        function _lookUpLine(_arg){
            for(let i=_xpos[0];i<=_xpos[3];i++){
                if(_numbers[i][2]==_arg){   
                    return true
                }                    
            }
            return false
        }

        function _workOut(_sX,_sY,_tX,_tY){  

            if((_status=="LOOKUP")){
                createPathWay(_sX,_sY,_tX,_tY,_sX,_sY)                             
                _status="LOOMUP"                
                return
            }            
           
            let a = pathWay[counter];
            let b = pathWay[counter+1];
            
            //need rescue 8 is trap in lower left
            if((targetNum==8) && (_numbers[12][2]==8) && (_oO == true)) {                    
                _oO = false           
                topY+=1
                _status="LOOKUP"
                counter=0
                return
            }

            if((targetNum==_five) && (_status!="REARRANGE")){
                _five+=4;
                createPathWay(0,_o[0],3,_o[1],0,_o[0])                
                _status="ISALIGN"
                counter=0
                return
            }

            switch(_status) {
                case "ISALIGN":
                    if(isAlign(...ar)==true){
                        ar=ar.map(x=>x+4)
                        _xpos=_xpos.map(x=>x+4)
                        _o=_o.map(x=>x+1)
                        if(_oO==true){
                            topY+=1
                        }                    
                        _tail=targetNum
                        
                        if(targetNum==9){                                      
                            createPathWay(_sX,_sY,_tX,_tY,_tX,topY)    //top should be adjustable                    
                            _status="TTOP"
                        }else{
                            _status="LOOKUP"     
                        }
                        
                        if(targetNum==13){
                            if((_numbers[12][2]==13) && (_numbers[13][2]==14)){
                                console.log("FINISH")
                                _engine="STOP"
                                return
                                //location.reload()
                            }else{                          
                                _state ="A"
                                _status="REARRANGE"
                                return
                            }                        
                        }
                        counter=0
                        return
                    }                    

                    break

                case "REARRANGE":
                    if((_numbers[9][2]==12) && (_state=="A")){
                        createPathWay(_sX,_sY,3,3,3,3)    
                        _state="B"
                        counter=0
                        return
                    }
                    if(_state=="B"){
                        if(_numbers[14][2]==13){
                            _state="C"
                            createPathWay(0,2,3,3,3,3)
                            counter = 0
                            return
                        }
                    }
                    if(_state=="C"){
                        if((_numbers[8][2]==9) && ((_numbers[15][2]==0))){                        
                            console.log("FINISH")
                            //location.reload()
                            _engine="STOP"
                            return
                        }                    
                    }
                    break

                case "LOOMUP":
                    if(_numbers[b][2]==targetNum){                                   
                        createPathWay(_sX,_sY,_tX,_tY,3,_tY)                           
                        if(obstacle()==true){
                            targetNum=5
                            _tail=5
                            _status="LOOKUP"
                            counter=0
                            return
                        }                    
                        _status="TRIGHT"
                        counter=0
                        return
                    }                    
                    break                                                                                                                                           

                case "TRIGHT":
                    if((_sX==3) && (_tX==3)){
                        createPathWay(_sX,_sY,_tX,_tY,_tX,topY)    //top should be adjust table                    
                        _status="TTOP"
                        counter=0
                        return
                    }
                    break
                
                case "TTOP":
                    if((_sY==topY) && (_tY==topY)){   //top should be adjust table                                            
                        if(targetNum==_tail){
                            targetNum+=1
                        }                    
                        _reset()
                        return
                    }
                    break

                case "SLIDE":                    
                    if((_numbers[_xpos[1]][2]==_tail) && (_numbers[_xpos[1]+1][2]==0)){                    
                        if(_lookUpLine(targetNum)==false){                           
                            _status="LOOKUP"
                            counter=0
                            return
                        }                
                    }
                    _slide()
                    break

                case "AHEAD":
                    if(_numbers[_hold-1][2]==targetNum){
                        _reset()
                    }
                    break

                case "CRESCENT":
                    if(counter==2){
                        _reset()
                        return
                    }
                    break
                case "PIVOT":
                    if(obstacle()==true){
                        _status="CRESCENT"
                    }
                    if(_numbers[_hold][2]==targetNum){
                        targetNum+=1
                        _tail+=1
                        _reset()
                        return
                    }
                    break
                default:
            }

            function _slide(){                
                for(let i=0;i<=3;i++){        
                    let _x = (xp)=>{
                        if(xp>=6){
                            return xp-=1
                        }else{
                            return xp+=1
                        }
                    }
                    _hold = _x(_xpos[i])   
                                          
                    if((_numbers[_xpos[1]+1][2]==_tail) && (_numbers[_xpos[1]][2]==targetNum) && (_numbers[_xpos[1]+4][2]==0)){
                        createPathWay(_sX-1,_sY,_tX,_tY,_tX,_tY)                          
                        _status="AHEAD"                                  
                        counter=0                  
                    }
                    
                    if((_numbers[_xpos[i]][2]==_tail) && (_numbers[_hold][2]==0) ){                    
                        if(_lookUp(_xpos[i])==true){
                            createPathWay(_sX,_sY,_tX,_tY,_tX,_tY)                              
                            _status="PIVOT"  
                            counter=0                            
                            if(obstacle()==true){
                                createPathWay(_sX-1,_sY,_tX,_tY,_tX,_tY)
                            }
                        return;
                        }                
                    }
                }
            }
                                
            _swap(a,b)                                
            
            counter+=1                
            if(counter==pathWay.length-1){ 
                counter=0
                return
            }
        }
        function _reload(){
            location.reload()
        }

        function _pause(){
            _isPause?_isPause=false:_isPause=true;
        }
    </script>
    <!--
    <button type="button" id="shuff" onclick="_reload()">Shuffle</button>  
    <button type="button" id="pause" onclick="_pause()">Pause</button> 
    -->
</body>
</html>


